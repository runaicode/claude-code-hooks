#!/usr/bin/env bash
# =============================================================================
# commit-msg-format.sh â€” Enforce Conventional Commits message format
#
# Validates commit messages against the Conventional Commits specification.
# Can be used as a git commit-msg hook or as a standalone validator.
#
# Usage:  .claude/hooks/commit-msg-format.sh <commit-msg-file>
#     or: echo "feat: add login" | .claude/hooks/commit-msg-format.sh
# Exit:   0 = valid, 1 = invalid format
# =============================================================================

set -euo pipefail

# Valid commit types per Conventional Commits spec
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Maximum subject line length
MAX_LENGTH=72

# Read commit message from file argument or stdin
if [[ -n "${1:-}" && -f "${1:-}" ]]; then
    MSG=$(head -1 "$1")
elif [[ ! -t 0 ]]; then
    MSG=$(head -1)
else
    echo "[commit-msg] Error: provide a commit message file or pipe message via stdin"
    echo "Usage: $0 <commit-msg-file>"
    echo "   or: echo 'feat: add feature' | $0"
    exit 1
fi

# Skip merge commits
if [[ "$MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip revert commits generated by git
if [[ "$MSG" =~ ^Revert\ \" ]]; then
    exit 0
fi

ERRORS=()

# Check: matches conventional commit pattern
# Format: type(scope)!: description
if ! echo "$MSG" | grep -qP "^($VALID_TYPES)(\([a-zA-Z0-9_/.-]+\))?(!)?\s*:\s+.+"; then
    ERRORS+=("Format must be: type(scope): description")
    ERRORS+=("  Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert")
    ERRORS+=("  Examples:")
    ERRORS+=("    feat: add user login flow")
    ERRORS+=("    fix(auth): handle expired tokens gracefully")
    ERRORS+=("    docs: update API reference for v2 endpoints")
    ERRORS+=("    refactor(db)!: migrate from SQL to NoSQL")
fi

# Check: subject line length
if [[ ${#MSG} -gt $MAX_LENGTH ]]; then
    ERRORS+=("Subject line is ${#MSG} chars (max $MAX_LENGTH)")
    ERRORS+=("  Move details to the commit body instead")
fi

# Check: no period at the end
if [[ "$MSG" =~ \.\s*$ ]]; then
    ERRORS+=("Subject line should not end with a period")
fi

# Check: description is not empty after the colon
if echo "$MSG" | grep -qP "^($VALID_TYPES)(\([^)]*\))?(!)?\s*:\s*$"; then
    ERRORS+=("Description after the colon cannot be empty")
fi

# Check: description starts with lowercase (convention)
DESC=$(echo "$MSG" | sed -E "s/^($VALID_TYPES)(\([^)]*\))?(!)?\s*:\s*//")
if [[ -n "$DESC" ]] && echo "$DESC" | grep -qP '^[A-Z]'; then
    ERRORS+=("Description should start with lowercase: '${DESC:0:1}' -> '$(echo "${DESC:0:1}" | tr '[:upper:]' '[:lower:]')'")
fi

# Output results
if [[ ${#ERRORS[@]} -eq 0 ]]; then
    echo "[commit-msg] Valid: $MSG"
    exit 0
else
    echo "[commit-msg] Invalid commit message: $MSG"
    echo ""
    for error in "${ERRORS[@]}"; do
        echo "  $error"
    done
    echo ""
    exit 1
fi
